//
//  ContentView.swift
//  Organisms
//
//  Created by Brett Meader on 14/01/2024.
//

import SwiftUI

let modelStructure = MLPNodeStructure(inputNodesCount: 8, hiddenNodesCount: 32, outputNodesCount: 4)
let modelWeights = ModelWeights(inputToHiddenWeights: [-0.36308533, 0.08290413, 0.27567402, 0.07649337, -0.21806383, 0.14730158, 0.7049068, 0.5463753, -0.6989615, 0.09325953, -0.28800577, 0.17841789, -0.43219054, 0.31441498, 0.33378798, -0.47263956, 0.4930367, 0.41260028, 0.1756452, -0.27642477, -0.036496736, 0.36482078, 0.5189308, 0.3739131, 0.19971307, 0.24562122, -0.3025471, 0.63131595, 0.50988704, -0.3339954, 0.091727674, -0.50799745, 0.044182315, 0.061025217, -0.299397, 0.26463175, -0.64651656, 0.056584775, -0.19472712, -0.1805954, 0.2865439, 0.15617207, 0.3940432, 0.5221358, -0.8220376, -0.26065493, -0.85558486, -0.2745868, -0.008681465, -0.36558002, -0.09725879, 0.15754038, 0.10764876, 0.13096187, -0.2997508, -0.41207314, -0.08307971, 0.13160852, 0.50925183, -0.18280903, 0.34855253, 0.28734672, -0.2817474, -0.02989399, 0.10736987, 0.6978401, -0.21121341, -0.82674503, 0.3491009, -0.18338951, -0.05153255, -0.11652817, 0.10608129, 0.035939656, 0.14870435, 0.08548963, -0.4068442, -0.40664905, 0.31229955, 0.3323652, 0.18682045, 0.27148166, -0.5846306, -0.009631168, -0.9224614, 0.3660692, -0.48388672, -0.25535452, 0.34647977, 0.21508414, -0.05363278, -0.47504264, -0.051934764, 0.25626153, -0.23864004, 0.09032424, 0.23708269, -0.1793558, 0.14183322, -0.077025115, -0.03613238, 0.010386981, 0.7133348, -0.95066166, -0.71784985, -0.17049241, 0.46337074, -0.63545406, 0.1571036, -0.2533843, -0.17344251, -0.07784644, 0.31232953, -0.41032636, -0.5725006, 0.5445324, 0.54134345, -0.3694548, -0.55477273, -0.043946393, 0.49607742, 0.38721865, 0.7577895, 0.22831002, 0.6178874, 0.18527511, -0.25781876, -0.5407046, 0.5007226, 0.24400961, 0.112020716, -0.8765669, -0.84241104, 0.27211776, 0.55121493, 0.24775061, -0.21515626, -0.507886, -0.34403372, -0.15302536, -0.5496081, 0.27730864, 0.1300889, 0.23820266, 0.7376791, 0.054019406, 0.17206213, -0.09222557, 0.0622537, -0.2478914, -0.48724002, 0.19362965, -0.19871739, -0.605127, 0.25197756, 0.4014489, -0.55687857, 0.2575724, -0.3726594, 0.63123286, 0.07480012, 0.030914117, -0.07634559, 0.4049248, 0.30103654, -0.018108625, -0.36500663, 0.9058882, -0.41694814, 0.3286584, -0.050100423, -0.2650563, -0.27780667, 0.24542433, 0.8039261, 0.5786263, -0.5763743, 0.13210744, -0.05666077, -0.28423733, 0.55594206, -0.46417457, -0.19812545, -0.2924918, -0.17313293, -0.5372833, 0.36143887, 0.7099521, 0.2648059, -0.10496391, -0.57878137, -0.32592285, 0.718395, 0.23756132, -0.7373756, 0.2787203, -0.1346355, -0.3020842, -0.485609, -0.4468459, 0.2771141, 0.013025949, 0.87657773, 0.46064192, -0.21053836, -0.15855634, 0.08883804, 0.008248525, 0.8944367, -0.32243636, -0.2624231, 0.05993755, 0.094684735, 0.2052662, -0.104788706, 0.046363275, -0.12834631, 0.1331668, 0.31728864, -0.87210906, -0.91148007, 0.34847873, 0.18976215, -0.09364113, 0.006114484, -0.82545614, 0.9484371, 0.19440013, 0.0071591726, -0.3002993, 0.049035907, 0.39430386, 0.32154614, -0.69011277, 0.23571676, -0.20092127, 0.0032636318, 0.4560358, -0.1413213, -0.7923384, -0.25145793, -0.55212146, 0.36249405, 0.2374061, 0.8280121, -0.038665965, -0.35383075, 0.22674507, -0.017671775, 0.43196952, 0.011787469, 0.021035679, 0.51604056, 0.3994825, 0.081944615, -0.005335316], inputToHiddenBias: [0.4544406, -0.035608605, -0.9441149, -0.7030765, -0.55364454, 0.08491449, -0.09761815, 0.37757993, -0.120655194, 0.520951, -0.2858262, -0.2981518, 0.9968829, -0.4537235, -0.2750221, -0.0940004, -0.45115358, 0.1621739, -0.4494304, -0.54706514, 0.3048625, 0.63968456, 0.5239343, -0.32277298, -0.5270034, -0.44591928, 0.6159111, -0.03328701, 0.1300772, -0.07518932, -0.10699815, -0.18701714, -0.68690586, 0.3735699, -0.29698777, -0.00075064664, -0.35120696, -0.058205783, -0.2521271, -0.71715117, -0.21856514, -0.15827861, 0.4848966, -0.62146294, -0.09437865, 0.055044062, 0.49439937, 0.38746208, 0.43748385, -0.6713159, 0.3336861, -0.078913435, 0.87799776, -0.8180448, 0.113666266, 0.024378281, -0.08846204, 0.38577867, -0.6101196, -0.45734894, -0.51889384, -0.64439774, 0.0038726963, -0.64048016, -0.87324905, 0.12040065, -0.05818101, -0.9225455, 0.3377843, -0.1226801, 0.6435207, 0.44600248, 0.76210654, 0.2345168, -0.67949224, 0.15406471, 0.8496977, -0.96931124, 0.3872651, 0.30738604, 0.9672005, 0.06595948, 0.83250916, -0.7699543, -0.009074906, -0.48601758, -0.042394124, -0.6883539, 0.34828115, -0.17531145, 0.6781813, 0.044337474, -0.9710994, -0.07401815, -0.46038985, 0.77870953, -0.7255714, -0.108858004, -0.27793312, 0.24951315, -0.47063422, -0.0769714, 0.5356138, -0.69366, -0.72041905, -0.41068023, -0.57935566, 0.9758439, -0.34706992, 0.3398189, -0.7065364, 0.8842932, 0.27270788, -0.5587044, 0.06885666, 0.10655591, 0.08754949, -0.5020819, -0.37665743, -0.6450664, 0.39554054, 0.13403688, -0.5105169, 0.73681885, 0.41922748, 0.4611922, 0.68485856, 0.9227613, -0.6774441, 0.90398276, 0.2236, -0.80468297, -0.15033907, -0.0684028, 0.5677475, -0.26152766, -0.804026, -0.82289815, 0.8907095, 0.46374494, 0.42504752, 0.12546775, 0.92224586, -0.8944989, 0.4103666, 0.5640406, 0.783082, 0.04113578, -0.053380437, 0.22905242, 0.80409, 0.91618764, -0.037217773, -0.8240272, -0.010059372, 0.6205636, -0.15403771, 0.4079436, -0.76338506, 0.2951461, 0.4410051, -0.92886484, -0.9485607, 0.044754833, -0.03977249, -0.59843135, 0.32455647, -0.13195327, 0.5415236, 0.022318155, 0.13977966, 0.8386098, 0.015072871, -0.9152479, 0.032167725, -0.043826886, -0.17853561, 0.8159549, -0.3483187, 0.5219848, 0.84423816, -0.25292584, 0.94038963, -0.102309674, -0.34181505, 0.3853386, -0.8516041, 0.19874245, 0.9958252, 0.06397229, -0.6209667, 0.7442275, 0.760305, 0.0064662043, 0.6234342, -0.05578711, -0.35280317, 0.20915866, -0.63178265, -0.023458786, -0.32241827, -0.5194244, 0.43058914, -0.7894579, 0.04244928, -0.43510318, 0.0015412443, -0.13789788, 0.02139021, -0.043723717, -0.61016774, 0.26460266, -0.668381, -0.25858542, 0.6844708, -0.3563215, -0.3101722, -0.4121387, 0.33187044, 0.15115297, 0.07906644, 0.6326462, -0.29432076, -0.69206023, 0.36892372, 0.3412416, 0.6523527, 0.92900646, -0.12826358, -0.48721266, 0.19844499, -0.27463347, 0.18931708, -0.057954207, -0.12838012, -0.48034602, 0.17631707, 0.6374215, -0.7810459, -0.31447613, -0.55015993, -0.3882263, 0.30179948, -0.18670619, -0.6703942, -0.22274885, 0.2181378, 0.1657857, -0.5426486, 0.6952889, -0.5196763, -0.20715109, 0.111569494, 0.13230222, 0.0032869182, 0.5095659], hiddenToOutputWeights: [0.1736424, -0.40561658, 0.15158698, -0.3028993, 0.018505275, 0.0746849, 0.14466631, -0.23025714, -0.2772933, -0.10886343, -0.031932186, -0.34535974, -0.013312859, -0.10334711, 0.10462551, 0.049843814, 0.8272463, -0.29656482, 0.6611564, -0.16610554, 0.18728444, -0.087811455, -0.41643697, -0.29946724, 0.41729784, -0.5416016, 0.5237824, -0.008339798, 0.8369384, -0.32017624, -0.26121506, 0.22234744, -0.29264298, -0.23512354, -0.20542829, 0.8055264, -0.42658573, 0.19718158, 0.12461786, -0.2222232, 0.64947605, -0.051125895, 0.2061273, -0.23960799, 0.27615893, 0.12160011, -0.29336387, 0.013921406, 0.16680431, -0.21818262, 0.23312747, 0.06526111, 0.39110833, 0.6093463, -0.14334139, 0.061860304, -0.27590266, -0.134352, -0.38150665, 0.53049994, -0.99308634, 0.10229954, -0.1804462, 0.45333785, 0.33877838, -0.72047234, 0.7869917, -0.24974242, -0.8139384, 0.21301144, 0.15223363, 0.062242135, -0.22746429, 0.3384816, 0.13493943, 0.19898853, -0.16478616, 0.5303704, -0.53009784, 0.07267143, -0.39594764, 0.13079648, -0.09557812, 0.16534024, -0.048354328, -0.037263125, 0.14416197, 0.0074627874, -0.012798522, 0.2914221, -0.0492995, 0.32689995, 0.8109392, 0.39509827, 0.11765416, -0.012220075, 0.20767176, -0.6891558, -0.053478606, 0.0025783894, -0.4612518, 0.09377517, 0.370794, 0.08534859, 0.25722563, 0.04686641, -0.18746571, -0.05110559, 0.22346103, -0.18641931, -0.3125627, -0.11691364, 0.12236881, 0.058600858, 0.13474682, -0.5986756, 0.25523415, 0.089258224, 0.20475802, 0.22226751, -0.37242395, -0.7478722, -0.22232315, 0.44832957, 0.80225444, -0.4575378, -0.8628329, 0.0061204312], hiddenToOutputBias: [0.026060704, 0.081857875, 0.08886291, -0.045088634, 0.058570724, 0.0015912927, 0.04128042, 0.009837337, 0.02468082, -0.007044561, 0.030526526, -0.082569554, -0.007463744, 0.03551893, -0.062066637, -0.01725731, -0.0002324084, 0.014049664, -0.033532895, -0.020293958, 0.06464052, -0.040043443, 0.011431452, 0.096360594, 0.08208156, -0.07493636, 0.02343253, -0.027508289, -0.017217524, -0.003096717, -0.04299152, 0.0057654586, 0.0026535727, 0.01651898, -0.000531063, -0.06566915, 0.034713283, 0.05380953, -0.072582364, -0.07290083, -0.03566552, 0.08264938, 0.012302022, -0.053435378, 0.06321281, 0.04273119, -0.071879804, 0.073844165, 0.09431611, 0.0145088695, 0.03870055, -0.007542543, -0.0041839234, 0.023503143, 0.007826746, -0.0023795036, 0.031129166, 0.02580716, -0.051666074, 0.014642583, -0.053940192, -0.035318546, -0.084853694, -0.0551954, -0.002608067, -0.044317797, -0.058373965, 0.0048014116, 0.031989936, 0.020735044, 0.009988977, 0.061568342, -0.0064969575, 0.014576709, 0.09143573, -0.04079576, 0.06666912, 0.013659982, -0.020128082, -0.027622458, 0.022397436, -0.022119172, -0.06998266, -0.026269488, -0.07016909, 0.032643206, 0.081385314, 0.03393811, -0.013522757, -0.067247525, -0.0072093783, -0.020515788, 0.007687306, 0.017760228, -0.046990484, 0.016449578, -0.07630409, -0.021304838, 0.03920261, 0.005446909, 0.057120413, -0.030080158, -0.025999065, -0.024669107, 0.06255779, -0.03825037, 0.09093788, 0.0096268505, -0.00025618105, 0.058723226, -0.014434438, -0.03875391, 0.04297871, 0.0289044, -0.011683062, 0.06430095, 0.007837617, -0.046824947, 0.028004315, -0.051060252, -0.05554171, -0.0736551, 0.038951293, 0.012308488, 0.032007404, -0.07818152, 0.042897437, 0.041581474])

@Observable
class SimulatorViewModel {
    
    var sim: Simulation = Simulation(modelWeights: modelWeights, modelStructure: modelStructure)

    @MainActor
    var organisms: [Organism] = []

    @MainActor
    var bots: [Bot] = []

    @MainActor
    var foods: [Food] = []

    func tick(dt: Float) async {
        await sim.tick(dt: dt)
        let organisms = await sim.organisms
        let bots = await sim.bots
        let foods = await sim.foods
        await MainActor.run {
            self.organisms = organisms
            self.bots = bots
            self.foods = foods
        }
    }
}

struct OrganismSimulator: View {
    var viewModel = SimulatorViewModel()
    var body: some View {
        ZStack {
            GroupBox {
                ChartContainer()
            }
            .padding()
            HUD()
                .padding()
        }
        .task {
            while(true) {
                await viewModel.tick(dt: 0.1)
            }
        }
        .padding()
        .background(.black)
        .foregroundStyle(.white)
        .environment(viewModel)
        .frame(minWidth: 375)
    }
}

//#Preview {
//    ContentView()
//}
