//
//  ContentView.swift
//  Organisms
//
//  Created by Brett Meader on 14/01/2024.
//

import SwiftUI

@MainActor
@Observable
class SimulatorViewModel {
    
    var sim: Simulation = Simulation()
//    var sim: Simulation = Simulation(organismWeights:
//                                        ModelWeights(inputToHiddenWeights: [0.4436887, 0.16943225, -0.144258, -0.6386957, -0.04995916, -0.40855306, 0.06025529, 0.05217872, -0.022386, -0.5702523, 0.65567786, -0.094215535, -0.14963534, 0.15837261, 0.7030858, 0.6728666, -0.1365815, 0.19079888, 0.38640398, -0.38919055, -0.23111232, -0.12379147, -0.03894404, 0.5883521, 0.577489, -0.8305768, -0.4492742, 0.458575, 0.226334, -0.16249935, -0.07980026, -0.34823164, 0.30182117, -0.096960805, 0.5351964, -0.33540693, 0.5869624, 0.556114, 0.08066862, 0.076719925, -0.20899652, -0.32981503, 0.5407171, 0.42948228, 0.6067884, -0.6913384, -0.25559425, 0.22111154, -0.04839337, 0.3159547, 0.26087427, 0.17386997, -0.08662797, -0.5996661, -0.29465973, 0.40049922, -0.08800559, 0.21117671, 0.7883922, 0.18372121, -0.3239837, 0.18633097, -0.07552593, 0.04520181], inputToHiddenBias: [-0.43836603, -0.27330965, 0.38706264, 0.55405545, 0.41173857, 0.06638484, 0.018331623, 0.78243506, -0.113024905, 0.25960177, -0.021393728, 0.705348, 0.069653794, 0.7372118, 0.71923554, 0.3316294, 0.39229682, 0.4808681, 0.49512273, 0.7320697, 0.775651, 0.30386066, 0.47461206, -0.12121972, 0.73275244, -0.64725435, -0.5009279, 0.5891503, 0.12440689, 0.73194444, 0.02875027, 0.35730988, 0.029203128, 0.50661194, 0.22902025, -0.06723659, 0.18996978, 0.30215704, 0.65871453, 0.16757987, -0.10949622, 0.20520367, 0.13581653, 0.62230396, -0.18423146, -0.4346922, -0.8855188, 0.913347, -0.011857871, -0.3249399, 0.77174175, 0.00660449, -0.07472501, -0.3234775, -0.7347586, -0.7939708, -0.2259128, -0.9260176, 0.04245928, -0.770684, 0.55014503, 0.7221211, 0.24827704, 0.44374323], hiddenToOutputWeights: [0.30782586, 0.06200186, -0.00022045427, 0.4407329, 0.28937596, 0.05476438, 0.15092616, -0.11816209, -0.06346688, -0.33867067, -0.12311816, -0.42922425, -0.70036536, -0.16178268, 0.029004183, 0.59653217, 0.27509063, 0.30220124, 0.6971947, -0.31297487, -0.14278409, 0.051644478, 0.008677253, 0.36256027, -0.4688534, -0.37090448, -0.021033881, 0.02659864, -0.019702535, 0.41210228, -0.37317678, 0.66817254], hiddenToOutputBias: [-0.08200115, -0.058746237, 0.0074769817, -0.022706721, -0.002028001, 0.02218084, -0.015111567, 0.025536254, 0.0104486365, -0.08589713, -0.0012719483, 0.07559133, 0.037208192, -0.073698096, 0.03174661, -0.048216984, -0.015556768, 0.02801789, 0.046370625, -0.015698861, -0.07421038, -0.024212543, -0.050965156, -0.07255964, 0.07486527, -0.041328173, 0.0311665, -0.06113231, 0.023354623, 0.07612826, -0.044567432, 0.05538739])
//    )
    var organisms: [Organism] = []
    var bots: [Bot] = []
    var foods: [Food] = []
    
    nonisolated func tick(dt: Float) async {
        var sim = await sim
        await sim.tick(dt: dt)
        let organisms = await sim.organisms
        let bots = await sim.bots
        let foods = await sim.foods
        await MainActor.run { [sim] in
            self.sim = sim
            self.organisms = organisms
            self.bots = bots
            self.foods = foods
        }
    }
}

@MainActor
enum Globals {
    static let simViewModel = SimulatorViewModel()
}

struct OrganismSimulator: View {
    let viewModel = Globals.simViewModel
    var body: some View {
        ZStack {
            GroupBox {
                ChartContainer()
            }
            .padding()
            HUD()
                .padding()
        }
        .task {
            while(true) {
                await viewModel.tick(dt: 0.1)
            }
        }
        .padding()
        .background(.black)
        .foregroundStyle(.white)
        .environment(viewModel)
        .frame(minWidth: 375)
    }
}

//#Preview {
//    ContentView()
//}
